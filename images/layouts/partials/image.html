{{/*
	MODULE: IMAGES
	Image
	---
	Turns an image resource into a `picture` element with LQIP, WEBp and PNG/JPEG fallback,
	plus still image fallback to make gifs accessible. Accepts URLs too but you won't get
	alternate formats/fallback.

	@NOTE Image size works, but images get cached, so you might have to restart to see changes.

	@TODO download external images {{- $dl := .Download | default false -}}
	@TODO refactor to make atts a dict rather than slice
	@TODO Clean this up so it's not enormous and horrifying
	---
	Params:
	- .Image		The image to show. Hugo Image or path as a string.
	- .Alt			Alt text, default blank.
	- .Lazy			Whether to lazy load the image, default true.
	- .Name			Name (without extension) for image file(s) made from conversions/cropping.
	- .Class		Class attribute value for the `picture` as a slice of values.
	- .ImgClass Ditto but for the image inside.
	- .ImgAtts	Additional atts for `<img>`, a slice of full name/value attribute markup.
	- .Width		Width of the image, default `.Width` if `.Image` is a resource. If
							specified without .Height, the aspect ratio is preserved.
	- .Height		Height of the image, default `.Height` if `.Image` is a resource. If
							specified without .Width, the aspect ratio is preserved.
	- .Download	@TODO If image is a string, whether to download and process a local copy.
	- [.Sources]  Slice of URLs for `source` elements, used if .Image is a string.
	- [.IsAlpha]	Whether image needs transparency (making JPEG fallback unacceptable), default true.
	- .Clamp		If it's an external URL, smash the image into your given dimensions.
							Assumes you are not already supplying a `style` value in `.ImgAtts`.
*/}}
{{- $image := .Image -}}

{{- $filename := .Name | default "" -}}
{{- $pathPrefix := cond .NoPrefix "" (site.Params.Images.PathPrefix | default "") -}}
{{- $alt := .Alt | htmlEscape | safeHTML | htmlUnescape | plainify -}}

{{- $srcsets := slice -}}
{{- $strSources := .Sources | default slice -}}
{{- $filetype := "" -}}
{{- /* Source for `data-iesrc` for Lozad's picture polyfill */ -}}
{{- $ieSrc := "" -}}
{{- $isAlpha := .IsAlpha | default true -}}

{{- $lazy := .Lazy | default true -}}
{{- $useLqip := .Lqip | default $lazy -}}
{{- $lqip := false -}}

{{- $class := .Class | default slice -}}
{{- $imgClass := .ImgClass | default slice -}}
{{- $imgAtts := .ImgAtts | default slice -}}

{{- $width := .Width | string -}}
{{- $height := .Height | string -}}
{{- $imgClamp := .Clamp | default false -}}

{{- with $image -}}
	{{- $isResource := eq (printf "%T" .) "*resources.resourceAdapter" -}}
	{{- if $isResource -}}

		{{- $filetype = .MediaType.SubType -}}

		{{- if eq $filename "" -}}
			{{- $filename = path.Join $pathPrefix .Name -}}
		{{- end -}}
		{{- $filename = strings.TrimSuffix (print "." $filetype) $filename -}}

		{{- if $useLqip -}}
			{{- /* LQIP */ -}}
			{{- $lqip = partialCached "module-images/functions/get-placeholder.html" (dict "Image" $image) .Name -}}
		{{- end -}}
		{{- $ieSrc = $image.Name -}}

		{{- if or $width $height -}}
			{{- $width = string ($width | default "") -}}
			{{- $height = string ($height | default "") -}}
		{{- else -}}
			{{- $width = $image.Width -}}
			{{- $height = $image.Height -}}
		{{- end -}}

		{{- $formats := slice "webp" -}}
		{{- if not $isAlpha -}}
			{{- if ne $filetype "jpeg" -}}
				{{- $formats = $formats | append "jpg" -}}
			{{- end -}}
		{{- else -}}
			{{- if eq $filetype "webp" -}}
				{{- $formats = $formats | append "png" -}}
			{{- end -}}
		{{- end -}}
		{{- /* @NOTE gif will be prioritized with media queries */ -}}
		{{- if and (not $isAlpha) (ne $filetype "png") -}}
			{{- $formats = uniq ($formats | append $filetype) -}}
		{{- end -}}

		{{- range $formats -}}
			{{- $ext := . -}}
			{{- with $image.Resize (print $width "x" $height " " $ext) -}}
				{{- $newImg := . | resources.Copy (print $filename "." $ext) -}}
				{{- $srcsets = $srcsets | append $newImg -}}
				{{- if eq $ext $filetype -}}
					{{- $image = $newImg -}}
				{{- end -}}
			{{- end -}}
		{{- end -}}

		{{- /* Reset dimensions in case one was automatically calculated when resized */ -}}
		{{- $width = string $image.Width -}}
		{{- $height = string $image.Height -}}
	{{- else -}}
		{{- $filetype =  strings.TrimPrefix "." (path.Ext .) -}}
		{{- $ieSrc = . -}}
		{{- $useLqip = false -}}

		{{- $strSources := (slice $image) | append $strSources -}}
		{{- range $strSources -}}
			{{- /* https://help.accusoft.com/PrizmViewer/v10.1/Config/MIME_Types.html */ -}}
			{{- $ext := strings.TrimPrefix "." (path.Ext .) -}}
			{{- /* @TODO download if $dl */ -}}
			{{- /* @NOTE dict here is pretending to be a Hugo image resource. */ -}}
			{{- $srcsets = $srcsets | append (dict
				"RelPermalink" .
				"MediaType" (dict "Type" (print "image/" $ext))
			) -}}
		{{- end -}}

		{{- if $imgClamp -}}
			{{- $style := "" -}}
			{{- if $width -}}
				{{- $style = printf `%swidth:%spx;` $style $width -}}
			{{- end -}}
			{{- if $height -}}
				{{- $style = printf `%sheight:%spx;` $style $height -}}
			{{- end -}}

			{{- $imgAtts = $imgAtts | append (printf `style="%s"` $style) -}}
			{{- $imgClass = $imgClass | append "object-cover" -}}
		{{- end -}}
	{{- end -}}

	{{- $isGif := eq $filetype "gif" -}}
	{{- if $isGif -}}
		{{- $class = $class | append "gif" -}}
	{{- end -}}
	{{- $class = $class | uniq -}}

	{{- /* --- IMG Attributes --- */ -}}
	{{- $srcCount := len $srcsets -}}
	{{- $usePicture := gt $srcCount 1 -}}

	{{- $imgAtts := $imgAtts | append (printf `alt="%s"` $alt) -}}
	{{- $pictureAtts := slice -}}

	{{- if $width -}}
		{{- $imgAtts = $imgAtts | append (printf `width="%s"` $width) -}}
	{{- end -}}
	{{- if $height -}}
		{{- $imgAtts = $imgAtts | append (printf `height="%s"` $height) -}}
	{{- end -}}

	{{- if $lazy -}}
		{{- $imgAtts = $imgAtts | append
			`loading="lazy"`
			`decoding="async"`
		-}}

		{{- if $usePicture -}}
			{{- $class = $class | append "lozad" -}}
			{{- $pictureAtts = $pictureAtts | append (slice
				(printf `data-iesrc="%s"` $ieSrc)
				(printf `data-alt="%s"` $alt)
			) -}}
		{{- else -}}
			{{- $imgClass = $imgClass | append "lozad" -}}
		{{- end -}}
	{{- end -}}

	{{- with $imgClass -}}
		{{- $imgClass = uniq $imgClass -}}
		{{- $imgAtts = $imgAtts | append (printf `class="%s"` (delimit . " ")) -}}
	{{- end -}}

	{{- with $class -}}
		{{- $class = uniq $class -}}
		{{- $pictureAtts = $pictureAtts | append (printf `class="%s"` (delimit $class " ")) -}}
	{{- end -}}


	{{- $ns1 := cond (and $lazy (not $isGif)) `<noscript>` "" -}}
	{{- $ns2 := cond (and $lazy (not $isGif)) `</noscript>` "" -}}

	{{- if $usePicture -}}
		<picture{{ with $pictureAtts }} {{ delimit . " " | safeHTMLAttr }}{{- end -}}>
			{{- $i := $srcCount -}}
			{{- range $srcsets -}}
				{{- if and (eq $i 1) (not $useLqip) -}}
					{{- $ns1 | safeHTML -}}
						<img src="{{- .RelPermalink -}}"{{ with $imgAtts }} {{ delimit . " " | safeHTMLAttr -}}{{- end -}}>
					{{- $ns2 | safeHTML -}}
				{{- else -}}
					<source srcset="{{- .RelPermalink -}}" {{ if $isGif -}}media="(prefers-reduced-motion: no-preference)"{{- else -}}type="{{- .MediaType.Type -}}"{{- end -}}>
				{{- end -}}
				{{- $i = sub $i 1 -}}
			{{- end -}}
			{{- if $useLqip -}}
				<img src="{{- $lqip | safeURL -}}"{{ with $imgAtts }} {{ delimit . " " | safeHTMLAttr -}}{{- end -}}>
			{{- end -}}
		</picture>
	{{- else -}}
		<img {{ if $lazy -}}data-{{- end -}}src="{{- $ieSrc -}}"{{ with $imgAtts }} {{ delimit . " " | safeHTMLAttr -}}{{- end -}}>
	{{- end -}}
{{- end -}}
