{{/*
	MODULE: IMAGES
	Image
	---
	Turns an image resource into a `picture` element with LQIP, webp and PNG fallback,
	plus still image fallback to make gifs accessible. Accepts URLs too but you won't get
	alternate formats/fallback.

	Note this template is SLOW, so maybe don't use it for every image on your site.

	@TODO can hugo save a url string image as a resource
	@TODO https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/fetchPriority
	---
	Params:
	- .Image		The image to show. Hugo Image or path as a string.
	- .Alt			Alt text, default blank.
	- .Lazy			Whether to lazy load the image, default true.
	- .Class		Class attribute value for the `picture` as a slice of values (eg. `slice "class1" "class2"`).
	- .ImgClass Ditto but for the image inside.
	- .ImgAtts			Additional atts for `<img>`, a slice of full name/value attribute markup.
	- .Width		Width of the image, default `.Width` if `.Image` is a resource. If
							specified without .Height, the aspect ratio is preserved.
	- .Height		Height of the image, default `.Height` if `.Image` is a resource. If
							specified without .Width, the aspect ratio is preserved.
	- .Download	If image is a string, whether to download and process a local copy. @TODO
	- .Sources  Slice of urls for source elements if .Image is a string
	- .Clamp		If it's an external URL, smash the image into your given dimensions.
							Assumes you are not already supplying a `style` value in `.ImgAtts`.
*/}}
{{- $image := .Image -}}
{{- $alt := .Alt | htmlUnescape | safeHTML | plainify -}}
{{- $lazy := .Lazy | default true -}}
{{- $class := .Class | default slice -}}
{{- $imgClass := .ImgClass | default slice -}}
{{- $name := .Name | default false -}}
{{- $customAtts := .ImgAtts | default slice -}}
{{- $width := .Width | string -}}
{{- $height := .Height | string -}}
{{- $sources := .Sources | default slice -}}
{{- $dl := .Download | default false -}}
{{- $imgClamp := .Clamp | default false -}}

{{- with $image -}}
	{{- /* Source used for the image element, which may become a LQIP */ -}}
	{{- $imgSrc := "" -}}
	{{- /* Source for `data-iesrc` for Lozad's picture polyfill */ -}}
	{{- $ieSrc := "" -}}

	{{- $filetype := ".png" -}}

	{{- $isResource := eq (printf "%T" .) "*resources.resourceAdapter" -}}
	{{- if $isResource -}}
		{{- $imgSrc = .RelPermalink -}}
		{{- $ieSrc = .RelPermalink -}}

		{{- $filetype = path.Ext .RelPermalink -}}

		{{- $newImage := $image -}}
		{{- if or $width $height -}}
			{{- $width = string ($width | default "") -}}
			{{- $height = string ($height | default "") -}}
		{{- else -}}
			{{- $width = $image.Width -}}
			{{- $height = $image.Height -}}
		{{- end -}}

		{{- $filename := $name -}}
		{{- if not $name -}}
			{{- $filename = path.Clean .RelPermalink -}}
			{{- $filename = strings.TrimSuffix $filetype $filename -}}
		{{- end -}}

		{{- $path := .RelPermalink -}}

		{{- $filetypes := slice "webp" "png" -}}
		{{- if $lazy -}}
			{{- /* LQIP */ -}}
			{{- $imgSrc = partialCached "functions/get-placeholder.html" (dict "Image" .) .RelPermalink -}}
		{{- else -}}
			{{- if eq $filetype "jpg" -}}
				{{- /* If original is jpg don't bother getting a png version */ -}}
				{{- $filetypes = $filetypes | symdiff (slice "png") -}}
			{{- else -}}
				{{- $filetypes = $filetypes | symdiff (slice (strings.TrimPrefix "." $filetype)) -}}
			{{- end -}}
		{{- end -}}

		{{- $sources = cond (eq $filetype ".avif") (slice $image) (slice) -}}
		{{- range $filetypes -}}
			{{- $ext := . -}}
			{{- with $newImage.Resize (print $width "x" $height " " $ext) -}}
				{{- $newImage = . | resources.Copy (print $filename "." $ext) -}}
				{{- $sources = $sources | append $newImage -}}
			{{- end -}}
		{{- end -}}
		{{- /* Update dimensions in case one was auto */ -}}
		{{- $width = string $newImage.Width -}}
		{{- $height = string $newImage.Height -}}
	{{- else -}}
		{{- $imgSrc = . -}}
		{{- $ieSrc = . -}}
		{{- $filetype = path.Ext $imgSrc -}}

		{{- $newSources := slice -}}
		{{- range $sources -}}
			{{- /* https://help.accusoft.com/PrizmViewer/v10.1/Config/MIME_Types.html */ -}}
			{{- $ext := path.Ext . -}}
			{{- $newSources = $newSources | append (dict
				"RelPermalink" .
				"MediaType" (dict "Type" (print "image/" $ext))) -}}
			{{- $sources = $newSources -}}
		{{- end -}}
	{{- end -}}

	{{- $isGif := eq $filetype ".gif" -}}
	{{- if $isGif -}}
		{{- $class = $class | append "gif" -}}
	{{- end -}}
	{{- $class = $class | uniq -}}

	{{- /* --- IMG Attributes --- */ -}}
	{{- $imgAtts := slice
		(printf `src="%s"` ($imgSrc | safeURL))
		(printf `alt="%s"` $alt)
		| append $customAtts
	-}}

	{{- $imgDims := "" -}}
	{{- if $width -}}
		{{- $imgAtts = $imgAtts | append (printf `width="%s"` $width) -}}
		{{- $imgDims = print $imgDims (printf `width:%spx;` $width) -}}
	{{- end -}}
	{{- if $height -}}
		{{- $imgAtts = $imgAtts | append (printf `height="%s"` $height) -}}
		{{- $imgDims = print $imgDims (printf `height:%spx;` $height) -}}
	{{- end -}}

	{{- if and $imgClamp (not $isResource) -}}
		{{- $imgAtts = $imgAtts | append (printf `style="%s"` $imgDims) -}}
		{{- $imgClass = $imgClass | append "object-cover" -}}
	{{- end -}}

	{{- with $imgClass -}}
		{{- $imgAtts = $imgAtts | append
			(printf `class="%s"` (delimit (uniq .) " ")) -}}
	{{- end -}}
	{{ if $lazy -}}
		{{- $imgAtts = $imgAtts | append
			`loading="lazy"`
			`decoding="async"`
		-}}
	{{- end -}}

	{{- $pictureAtts := slice -}}
	{{- if $lazy -}}
		{{- $class = $class | append "lozad" | uniq -}}
		{{- $pictureAtts = $pictureAtts | append (slice
			(printf `data-iesrc="%s"` $ieSrc)
			(printf `data-alt="%s"` $alt)
		) -}}
	{{- end -}}
	{{- if $class -}}
		{{- $pictureAtts = $pictureAtts | append (printf `class="%s"` (delimit $class " ")) -}}
	{{- end -}}

	<picture{{ with $pictureAtts }} {{ delimit . " " | safeHTMLAttr }}{{- end -}}>
		{{- range $sources }}
			<source srcset="{{- .RelPermalink | safeURL -}}" type="{{- .MediaType.Type -}}" {{ if $isGif -}}media="prefers-reduced-motion"{{- end -}}>
		{{- end -}}
		<img{{ with $imgAtts }} {{ delimit . " " | safeHTMLAttr -}}{{- end -}}>
	</picture>
{{- end -}}
